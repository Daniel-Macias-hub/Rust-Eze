{% extends "layouts/admin_base.html" %}

{% block title %}Gestión de Ventas - Admin{% endblock %}

{% block admin_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Gestión de Ventas</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registrarVentaModal">
        <i class="fas fa-plus me-2"></i>Registrar Venta
    </button>
</div>

<!-- Lista de Ventas -->
<div class="card fade-in">
    <div class="card-header">
        <h5 class="card-title mb-0"><i class="fas fa-shopping-cart me-2"></i>Historial de Ventas</h5>
    </div>
    <div class="card-body">
        {% if ventas %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID Venta</th>
                        <th>Cliente</th>
                        <th>Empleado</th>
                        <th>Fecha</th>
                        <th>Total</th>
                        <th>Método Pago</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for venta in ventas %}
                    <tr>
                        <td><strong>#{{ venta.venta_id }}</strong></td>
                        <td>{{ venta.cliente }}</td>
                        <td>{{ venta.empleado }}</td>
                        <td>{{ venta.fecha_venta[:16] }}</td>
                        <td><span class="price-tag">${{ "{:,.2f}".format(venta.total_venta) }}</span></td>
                        <td><span class="badge bg-secondary">{{ venta.metodo_pago }}</span></td>
                        <td>
                            <span class="badge 
                                {% if venta.estado_venta == 'Activa' %}bg-success
                                {% elif venta.estado_venta == 'Cancelada' %}bg-danger
                                {% else %}bg-warning{% endif %}">
                                {{ venta.estado_venta }}
                            </span>
                        </td>
                        <td>
                            {% if venta.estado_venta == 'Activa' %}
                            <button class="btn btn-sm btn-outline-danger"
                                    onclick="cancelarVenta({{ venta.venta_id }})"
                                    title="Cancelar venta">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            {% else %}
                            <span class="text-muted">No actions</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
            <h5 class="text-muted">No hay ventas registradas</h5>
            <p class="text-muted">Comienza registrando tu primera venta.</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registrarVentaModal">
                <i class="fas fa-plus me-2"></i>Registrar Primera Venta
            </button>
        </div>
        {% endif %}
    </div>
</div>



<!-- Modal para registrar venta -->
<div class="modal fade" id="registrarVentaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-cash-register me-2"></i>Registrar Nueva Venta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formRegistrarVenta">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Cliente *</label>
                                <select class="form-select" name="cliente_id" required id="selectCliente">
                                    <option value="">Cargando clientes...</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Vehículo *</label>
                                <select class="form-select" name="vehiculo_id" required id="selectVehiculo">
                                    <option value="">Cargando vehículos...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Método de Pago *</label>
                                <select class="form-select" name="metodo_pago" required>
                                    <option value="">Seleccionar método...</option>
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Tarjeta">Tarjeta de Crédito/Débito</option>
                                    <option value="Transferencia">Transferencia Bancaria</option>
                                    <option value="Financiamiento">Financiamiento</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Precio del Vehículo</label>
                                <input type="text" class="form-control" id="precioVehiculo" readonly
                                       placeholder="Seleccione un vehículo">
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Información:</strong> Al registrar una venta, el vehículo seleccionado cambiará automáticamente a estado "Vendido".
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="registrarVenta()" id="btnRegistrarVenta">
                    <i class="fas fa-check me-2"></i>Registrar Venta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para confirmar cancelación -->
<div class="modal fade" id="confirmarCancelacionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Cancelación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que quieres cancelar esta venta? El vehículo volverá a estar disponible.</p>
                <div class="alert alert-warning">
                    <strong>Advertencia:</strong> Esta acción no se puede deshacer fácilmente.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>No, mantener venta
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmarCancelacion">
                    <i class="fas fa-trash-alt me-1"></i>Sí, cancelar venta
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* eslint-disable no-unused-vars */

// Función para cargar clientes
// @ts-ignore
async function cargarClientes() {
    try {
        const selectCliente = document.getElementById('selectCliente');
        selectCliente.innerHTML = '<option value="">Seleccionar cliente...</option>';
        
        // Datos de prueba - en producción esto vendría de la API
        const clientes = [
            { cliente_id: 1, nombre_completo: 'Cliente Demo' }
        ];
        
        clientes.forEach(function(cliente) {
            const option = document.createElement('option');
            option.value = cliente.cliente_id;
            option.textContent = cliente.nombre_completo;
            selectCliente.appendChild(option);
        });
    } catch (error) {
        console.error('Error cargando clientes:', error);
    }
}

// Función para cargar vehículos disponibles
// @ts-ignore
async function cargarVehiculosDisponibles() {
    try {
        const selectVehiculo = document.getElementById('selectVehiculo');
        selectVehiculo.innerHTML = '<option value="">Seleccionar vehículo...</option>';
        
        // Datos de prueba - en producción esto vendría de la API
        const vehiculos = [
            { vehiculo_id: 1, marca: 'Toyota', modelo: 'Corolla', precio: 450000.00 },
            { vehiculo_id: 2, marca: 'Honda', modelo: 'CR-V', precio: 620000.00 },
            { vehiculo_id: 3, marca: 'Ford', modelo: 'Mustang', precio: 1100000.00 }
        ];
        
        vehiculos.forEach(function(vehiculo) {
            const option = document.createElement('option');
            option.value = vehiculo.vehiculo_id;
            option.textContent = vehiculo.marca + ' ' + vehiculo.modelo + ' - $' + vehiculo.precio.toLocaleString();
            option.setAttribute('data-precio', vehiculo.precio);
            selectVehiculo.appendChild(option);
        });
    } catch (error) {
        console.error('Error cargando vehículos:', error);
    }
}

// Actualizar precio cuando se selecciona un vehículo
document.getElementById('selectVehiculo').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const precio = selectedOption.getAttribute('data-precio');
    const precioVehiculo = document.getElementById('precioVehiculo');
    if (precioVehiculo) {
        precioVehiculo.value = precio ? '$' + parseFloat(precio).toLocaleString() : '';
    }
});

// Función para registrar venta
// @ts-ignore
async function registrarVenta() {
    const form = document.getElementById('formRegistrarVenta');
    if (!form) return;
    
    const formData = new FormData(form);
    
    // Convertir FormData a objeto simple
    const data = {};
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // Validación
    if (!data.cliente_id || !data.vehiculo_id || !data.metodo_pago) {
        if (typeof showNotification === 'function') {
            showNotification('❌ Por favor complete todos los campos requeridos.', 'error');
        } else {
            alert('❌ Por favor complete todos los campos requeridos.');
        }
        return;
    }
    
    try {
        let result;
        if (typeof apiCall === 'function') {
            result = await apiCall('/admin/api/registrar-venta', data);
        } else {
            // Fallback si apiCall no está disponible
            result = { success: true, message: 'Venta registrada (simulada)' };
        }
        
        if (result.success) {
            if (typeof showNotification === 'function') {
                showNotification('✅ ' + result.message, 'success');
            } else {
                alert('✅ ' + result.message);
            }
            
            // Cerrar modal usando Bootstrap JavaScript
            const modalElement = document.getElementById('registrarVentaModal');
            if (modalElement && typeof bootstrap !== 'undefined') {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) modal.hide();
            }
            
            form.reset();
            
            setTimeout(function() { 
                location.reload(); 
            }, 1500);
        } else {
            if (typeof showNotification === 'function') {
                showNotification('❌ ' + result.message, 'error');
            } else {
                alert('❌ ' + result.message);
            }
        }
    } catch (error) {
        if (typeof showNotification === 'function') {
            showNotification('❌ Error de conexión al registrar venta', 'error');
        } else {
            alert('❌ Error de conexión al registrar venta');
        }
    }
}

// Función para mostrar modal de confirmación de cancelación
// @ts-ignore
function cancelarVenta(ventaId) {
    const modalElement = document.getElementById('confirmarCancelacionModal');
    if (!modalElement) return;

    const modal = new bootstrap.Modal(modalElement);
    const btnConfirmar = document.getElementById('btnConfirmarCancelacion');

    // Usamos .onclick para asegurarnos de que solo haya un listener a la vez
    btnConfirmar.onclick = async () => {
        try {
            let result;
            if (typeof apiCall === 'function') {
                result = await apiCall('/admin/api/cancelar-venta', { venta_id: ventaId });
            } else {
                result = { success: true, message: 'Venta cancelada (simulada)' };
            }
            
            modal.hide();

            if (result.success) {
                if (typeof showNotification === 'function') {
                    showNotification('✅ ' + result.message, 'success');
                } else {
                    alert('✅ ' + result.message);
                }
                setTimeout(() => location.reload(), 1500);
            } else {
                if (typeof showNotification === 'function') {
                    showNotification('❌ ' + result.message, 'error');
                } else {
                    alert('❌ ' + result.message);
                }
            }
        } catch (error) {
            modal.hide();
            if (typeof showNotification === 'function') {
                showNotification('❌ Error de conexión al cancelar venta', 'error');
            } else {
                alert('❌ Error de conexión al cancelar venta');
            }
        }
    };

    modal.show();
}

// Cargar clientes y vehículos cuando se abre el modal
document.getElementById('registrarVentaModal').addEventListener('show.bs.modal', async function() {
    await cargarClientes();
    await cargarVehiculosDisponibles();
});
</script>
{% endblock %}