{% extends "layouts/admin_base.html" %}

{% block title %}Gestionar Veh√≠culos - Admin{% endblock %}

{% block admin_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Gesti√≥n de Veh√≠culos</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#agregarVehiculoModal">
        <i class="fas fa-plus me-2"></i>Agregar Veh√≠culo
    </button>
</div>

<!-- Lista de Veh√≠culos -->
<div class="card fade-in">
    <div class="card-header">
        <h5 class="card-title mb-0"><i class="fas fa-car me-2"></i>Inventario de Veh√≠culos</h5>
    </div>
    <div class="card-body">
        {% if vehiculos %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Marca/Modelo</th>
                        <th>A√±o</th>
                        <th>Precio</th>
                        <th>Tipo</th>
                        <th>Color</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vehiculo in vehiculos %}
                    <tr>
                        <td><strong>#{{ vehiculo.vehiculo_id }}</strong></td>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if vehiculo.imagen_url %}
                                <img src="{{ vehiculo.imagen_url }}" alt="{{ vehiculo.marca }} {{ vehiculo.modelo }}" 
                                     class="rounded me-3" style="width: 50px; height: 40px; object-fit: cover;">
                                {% else %}
                                <i class="fas fa-car text-muted me-3" style="font-size: 1.5rem;"></i>
                                {% endif %}
                                <div>
                                    <strong>{{ vehiculo.marca }}</strong><br>
                                    <small class="text-muted">{{ vehiculo.modelo }}</small>
                                </div>
                            </div>
                        </td>
                        <td>{{ vehiculo.anio }}</td>
                        <td><span class="price-tag">${{ "{:,.2f}".format(vehiculo.precio) }}</span></td>
                        <td><span class="badge bg-secondary">{{ vehiculo.tipo }}</span></td>
                        <td>
                            <span class="badge text-dark" style="background-color: {{ vehiculo.color }};">
                                {{ vehiculo.color }}
                            </span>
                        </td>
                        <td>
                            <span class="badge 
                                {% if vehiculo.estado_disponibilidad == 'Disponible' %}bg-success
                                {% elif vehiculo.estado_disponibilidad == 'Vendido' %}bg-danger
                                {% else %}bg-warning{% endif %}">
                                {{ vehiculo.estado_disponibilidad }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" 
                                        onclick="editarVehiculo({{ vehiculo.vehiculo_id }})"
                                        title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-info"
                                        onclick="verDetalles({{ vehiculo.vehiculo_id }})"
                                        title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-danger"
                                        onclick="eliminarVehiculo({{ vehiculo.vehiculo_id }})"
                                        title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-car fa-4x text-muted mb-3"></i>
            <h5 class="text-muted">No hay veh√≠culos en el inventario</h5>
            <p class="text-muted">Comienza agregando tu primer veh√≠culo al sistema.</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#agregarVehiculoModal">
                <i class="fas fa-plus me-2"></i>Agregar Primer Veh√≠culo
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para agregar veh√≠culo -->
<div class="modal fade" id="agregarVehiculoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Agregar Nuevo Veh√≠culo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formAgregarVehiculo">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Marca *</label>
                                <input type="text" class="form-control" name="marca" required 
                                       placeholder="Ej: Toyota, Honda, Ford...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Modelo *</label>
                                <input type="text" class="form-control" name="modelo" required
                                       placeholder="Ej: Corolla, Civic, Mustang...">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">A√±o *</label>
                                <input type="number" class="form-control" name="anio" 
                                       min="2000" max="2030" required
                                       value="2024">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Precio *</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" name="precio" 
                                           step="0.01" min="0" required
                                           placeholder="0.00">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Color *</label>
                                <input type="text" class="form-control" name="color" required
                                       placeholder="Ej: Rojo, Azul, Negro...">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Tipo *</label>
                                <select class="form-select" name="tipo" required>
                                    <option value="">Seleccionar tipo...</option>
                                    <option value="Sedan">Sed√°n</option>
                                    <option value="SUV">SUV</option>
                                    <option value="Pickup">Pickup</option>
                                    <option value="Deportivo">Deportivo</option>
                                    <option value="Hatchback">Hatchback</option>
                                    <option value="Coupe">Coup√©</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Estado *</label>
                                <select class="form-select" name="estado_disponibilidad" required>
                                    <option value="Disponible">Disponible</option>
                                    <option value="Reservado">Reservado</option>
                                    <option value="Mantenimiento">Mantenimiento</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Descripci√≥n</label>
                        <textarea class="form-control" name="descripcion" rows="3" 
                                  placeholder="Describe las caracter√≠sticas del veh√≠culo..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">URL de Imagen</label>
                        <input type="url" class="form-control" name="imagen_url" 
                               placeholder="https://ejemplo.com/imagen.jpg">
                        <div class="form-text">Opcional. URL de una imagen del veh√≠culo.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="agregarVehiculo()">
                    <i class="fas fa-save me-2"></i>Guardar Veh√≠culo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para confirmar eliminaci√≥n -->
<div class="modal fade" id="confirmarEliminacionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Eliminaci√≥n
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¬øEst√°s seguro de que quieres eliminar este veh√≠culo? Esta acci√≥n no se puede deshacer.</p>
                <div class="alert alert-danger">
                    <strong>Advertencia:</strong> El veh√≠culo se eliminar√° permanentemente del inventario.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmarEliminacion">
                    <i class="fas fa-trash-alt me-1"></i>S√≠, eliminar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* eslint-disable no-unused-vars */

// Funci√≥n para agregar veh√≠culo
// @ts-ignore
async function agregarVehiculo() {
    const form = document.getElementById('formAgregarVehiculo');
    if (!form) return;
    
    const formData = new FormData(form);
    
    // Convertir FormData a objeto simple
    const data = {};
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // Validaci√≥n b√°sica
    if (!data.marca || !data.modelo || !data.precio) {
        alert('Por favor complete todos los campos requeridos.');
        return;
    }
    
    try {
        let result;
        if (typeof apiCall === 'function') {
            result = await apiCall('/admin/api/agregar-vehiculo', data);
        } else {
            result = { success: true, message: 'Veh√≠culo agregado (simulada)' };
        }
        
        if (result.success) {
            if (typeof showNotification === 'function') {
                showNotification('‚úÖ ' + result.message, 'success');
            } else {
                alert('‚úÖ ' + result.message);
            }
            
            // Cerrar modal usando Bootstrap JavaScript
            const modalElement = document.getElementById('agregarVehiculoModal');
            if (modalElement && typeof bootstrap !== 'undefined') {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) modal.hide();
            }
            
            form.reset();
            
            // Recargar la p√°gina despu√©s de 1 segundo
            setTimeout(function() {
                location.reload();
            }, 1000);
        } else {
            if (typeof showNotification === 'function') {
                showNotification('‚ùå ' + result.message, 'error');
            } else {
                alert('‚ùå ' + result.message);
            }
        }
    } catch (error) {
        if (typeof showNotification === 'function') {
            showNotification('‚ùå Error de conexi√≥n', 'error');
        } else {
            alert('‚ùå Error de conexi√≥n');
        }
    }
}

// Funci√≥n para editar veh√≠culo
// @ts-ignore
function editarVehiculo(id) {
    if (typeof showNotification === 'function') {
        showNotification('‚úèÔ∏è Funcionalidad de edici√≥n en desarrollo', 'info');
    } else {
        alert('‚úèÔ∏è Funcionalidad de edici√≥n en desarrollo');
    }
}

// Funci√≥n para ver detalles
// @ts-ignore
function verDetalles(id) {
    if (typeof showNotification === 'function') {
        showNotification('üëÅÔ∏è Funcionalidad de detalles en desarrollo', 'info');
    } else {
        alert('üëÅÔ∏è Funcionalidad de detalles en desarrollo');
    }
}

// Funci√≥n para eliminar veh√≠culo
// @ts-ignore
function eliminarVehiculo(id) {
    const modalElement = document.getElementById('confirmarEliminacionModal');
    if (!modalElement) return;

    const modal = new bootstrap.Modal(modalElement);
    const btnConfirmar = document.getElementById('btnConfirmarEliminacion');

    btnConfirmar.onclick = async () => {
        try {
            let result;
            // Simulaci√≥n de llamada a API
            if (typeof apiCall === 'function') {
                result = await apiCall(`/admin/api/eliminar-vehiculo`, { vehiculo_id: id });
            } else {
                result = { success: true, message: 'Veh√≠culo eliminado (simulado)' };
            }

            modal.hide();

            if (result.success) {
                if (typeof showNotification === 'function') {
                    showNotification('‚úÖ ' + result.message, 'success');
                } else {
                    alert('‚úÖ ' + result.message);
                }
                setTimeout(() => location.reload(), 1500);
            } else {
                if (typeof showNotification === 'function') {
                    showNotification('‚ùå ' + result.message, 'error');
                } else {
                    alert('‚ùå ' + result.message);
                }
            }
        } catch (error) {
            modal.hide();
            if (typeof showNotification === 'function') {
                showNotification('‚ùå Error de conexi√≥n al eliminar', 'error');
            } else {
                alert('‚ùå Error de conexi√≥n');
            }
        }
    };

    modal.show();
}
</script>
{% endblock %}