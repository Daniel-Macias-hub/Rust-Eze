{% extends "layouts/client_base.html" %}

{% block title %}Cat√°logo - Cliente{% endblock %}

{% block client_content %}
<div class="container-fluid py-4 client-dashboard-shell">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom border-secondary">
        <h1 class="h2 text-light mb-0">Cat√°logo de Veh√≠culos</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <span id="catalogoCount" class="badge bg-primary fs-6">
                {{ vehiculos|length }} veh√≠culos disponibles
            </span>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card card-hover-glow mb-4">
        <div class="card-body">
            <form id="filtrosForm" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Marca</label>
                    <select class="form-select" name="marca" onchange="aplicarFiltros()">
                        <option value="todas">Todas las marcas</option>
                        {% for marca in marcas %}
                        <option value="{{ marca }}">{{ marca }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tipo</label>
                    <select class="form-select" name="tipo" onchange="aplicarFiltros()">
                        <option value="todos">Todos los tipos</option>
                        <option value="Sedan">Sed√°n</option>
                        <option value="SUV">SUV</option>
                        <option value="Pickup">Pickup</option>
                        <option value="Deportivo">Deportivo</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Precio M√≠nimo</label>
                    <input type="number" class="form-control" name="precio_min" placeholder="0"
                           onchange="aplicarFiltros()">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Precio M√°ximo</label>
                    <input type="number" class="form-control" name="precio_max" placeholder="1000000"
                           onchange="aplicarFiltros()">
                </div>
            </form>
        </div>
    </div>

    <!-- Grid de Veh√≠culos -->
    <div class="row" id="vehiculosGrid">
        {% if vehiculos %}
            {% for vehiculo in vehiculos %}
            <div class="col-xl-4 col-lg-6 mb-4 vehiculo-item" 
                 data-marca="{{ vehiculo.marca|lower }}"
                 data-tipo="{{ vehiculo.tipo|lower }}"
                 data-precio="{{ vehiculo.precio }}">
                <div class="card vehicle-card h-100">

                    {% if vehiculo.imagen_url %}
                    <img src="{{ vehiculo.imagen_url }}"
                         class="card-img-top vehicle-img"
                         alt="{{ vehiculo.marca }} {{ vehiculo.modelo }}"
                         style="height: 220px; object-fit: cover;">
                    {% else %}
                    <div class="bg-dark d-flex align-items-center justify-content-center vehicle-img" style="height: 220px;">
                        <i class="fas fa-car fa-3x text-muted"></i>
                    </div>
                    {% endif %}

                    <div class="card-body">
                        <h5 class="card-title text-light">{{ vehiculo.marca }} {{ vehiculo.modelo }}</h5>
                        <p class="card-text text-muted">
                            {{ vehiculo.anio }} ‚Ä¢ {{ vehiculo.color }} ‚Ä¢ {{ vehiculo.tipo }}
                        </p>
                        <p class="card-text text-soft">
                            {{ vehiculo.descripcion or 'Veh√≠culo en excelentes condiciones.' }}
                        </p>

                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span class="price-tag">
                                ${{ "{:,.2f}".format(vehiculo.precio) }}
                            </span>
                            <span class="badge
                                {% if vehiculo.estado_disponibilidad == 'Disponible' %}bg-success
                                {% elif vehiculo.estado_disponibilidad == 'Reservado' %}bg-warning text-dark
                                {% elif vehiculo.estado_disponibilidad == 'Vendido' %}bg-secondary
                                {% else %}bg-dark{% endif %}">
                                {{ vehiculo.estado_disponibilidad }}
                            </span>
                        </div>
                    </div>

                    <div class="card-footer bg-transparent">
                        <div class="btn-group w-100 mb-2">
                            <button class="btn btn-outline-primary"
                                    onclick="solicitarTestDrive('{{ vehiculo.vehiculo_id }}')">
                                <i class="fas fa-calendar me-1"></i>Test Drive
                            </button>
                            <button class="btn btn-primary"
                                    onclick="contactarPorVehiculo('{{ vehiculo.vehiculo_id }}')">
                                <i class="fas fa-info-circle me-1"></i>M√°s Info
                            </button>
                        </div>

                        <!-- Bot√≥n de compra (POST a client.comprar) -->
                        <form method="POST"
                              action="{{ url_for('client.comprar', vehiculo_id=vehiculo.vehiculo_id) }}"
                              class="d-grid">
                            <button type="submit"
                                    class="btn btn-success"
                                    {% if vehiculo.estado_disponibilidad != 'Disponible' %}disabled{% endif %}>
                                <i class="fas fa-shopping-cart"></i> Comprar Ahora
                            </button>
                        </form>
                    </div>

                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-car fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">No hay veh√≠culos disponibles</h5>
                <p class="text-muted">Pronto tendremos nuevos veh√≠culos en nuestro cat√°logo.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* eslint-disable no-unused-vars */

// @ts-ignore
function aplicarFiltros() {
    const form = document.getElementById('filtrosForm');
    if (!form) return;
    
    const formData = new FormData(form);
    const marcaFiltro = (formData.get('marca') || 'todas').toLowerCase();
    const tipoFiltro = (formData.get('tipo') || 'todos').toLowerCase();
    const precioMin = parseFloat(formData.get('precio_min')) || 0;
    const precioMax = parseFloat(formData.get('precio_max')) || Infinity;

    const vehiculos = document.querySelectorAll('.vehiculo-item');
    let visibleCount = 0;

    vehiculos.forEach(vehiculo => {
        const marca = vehiculo.dataset.marca || '';
        const tipo = vehiculo.dataset.tipo || '';
        const precio = parseFloat(vehiculo.dataset.precio) || 0;

        const muestraMarca = marcaFiltro === 'todas' || marca === marcaFiltro;
        const muestraTipo = tipoFiltro === 'todos' || tipo === tipoFiltro;
        const muestraPrecio = precio >= precioMin && precio <= precioMax;

        if (muestraMarca && muestraTipo && muestraPrecio) {
            vehiculo.style.display = 'block';
            visibleCount++;
        } else {
            vehiculo.style.display = 'none';
        }
    });

    // Actualizar contador
    const badge = document.getElementById('catalogoCount');
    if (badge) {
        badge.textContent = visibleCount + ' veh√≠culos disponibles';
    }
}

// @ts-ignore
function solicitarTestDrive(vehiculoId) {
    const id = parseInt(vehiculoId);
    const fecha = prompt(
        `¬øPara qu√© fecha le gustar√≠a programar el test drive para el veh√≠culo ID ${id}? (YYYY-MM-DD)`
    );
    if (fecha) {
        if (typeof showNotification === 'function') {
            showNotification(`üìÖ Test drive solicitado para veh√≠culo ${id} - ${fecha}`, 'info');
        } else {
            alert(`üìÖ Test drive solicitado para veh√≠culo ${id} - ${fecha}`);
        }
    }
}

// @ts-ignore
function contactarPorVehiculo(vehiculoId) {
    const id = parseInt(vehiculoId);
    if (typeof showNotification === 'function') {
        showNotification(`üìû Conectando con asesor para veh√≠culo ${id}...`, 'info');
        setTimeout(() => {
            showNotification(
                `‚úÖ Un asesor se contactar√° con usted pronto sobre el veh√≠culo ${id}`,
                'success'
            );
        }, 1500);
    } else {
        alert(`üìû Conectando con asesor para veh√≠culo ${id}...`);
        setTimeout(() => {
            alert(`‚úÖ Un asesor se contactar√° con usted pronto sobre el veh√≠culo ${id}`);
        }, 1500);
    }
}
</script>

<style>
  /* Fondo y tema del panel de cliente (mismo que dashboard) */
  body {
    background: radial-gradient(circle at 0% 0%, #020617 0%, #020617 35%, #0b1120 75%, #111827 100%) !important;
    color: #f9fafb;
  }

  .client-dashboard-shell {
    background-color: transparent !important;
  }

  /* Tarjetas oscuras tipo glassmorphism */
  .card {
    background-color: rgba(15, 23, 42, 0.96);
    border: 1px solid rgba(148, 163, 184, 0.35);
    color: #e5e7eb;
    backdrop-filter: blur(16px);
  }

  .card .form-label,
  .card .text-muted,
  .card .card-text {
    color: #9ca3af !important;
  }

  .vehicle-card {
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
  }

  .vehicle-img {
    border-bottom: 1px solid rgba(15, 23, 42, 0.9);
  }

  .price-tag {
    color: #22c55e;
    font-weight: 700;
    font-size: 1rem;
  }

  .badge.bg-primary {
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
  }
</style>
{% endblock %}
