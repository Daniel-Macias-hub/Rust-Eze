{% extends "layouts/client_base.html" %}
{% block title %}Panel de cliente - Rust-Eze{% endblock %}

{% block client_content %}
<div class="container-fluid py-4">

  <!-- HERO -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm bg-transparent">
        <div class="card-body px-0">
          <span class="badge bg-primary bg-gradient mb-2">
            <i class="fa-solid fa-user-gear me-1"></i> Panel de cliente
          </span>
          <h2 class="h3 text-white mb-1">
            Explora, elige y compra tu próximo vehículo.
          </h2>
          <p class="text-soft mb-0">
            Bienvenido, {{ session.get('user_name') }}. Aquí puedes ver los vehículos disponibles
            y filtrar según tus preferencias.
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">

    <!-- ======================================
         COLUMNA IZQUIERDA: FILTROS + CATÁLOGO
         ====================================== -->
    <div class="col-lg-8">

      <!-- FILTROS -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-filter me-2"></i> Filtros</span>
          <button type="button" class="btn btn-sm btn-outline-light" onclick="limpiarFiltros()">
            Limpiar filtros
          </button>
        </div>
        <div class="card-body">
          <form id="filtrosForm" class="row g-3">
            <div class="col-md-6 col-xl-3">
              <label class="form-label">Marca</label>
              <select class="form-select form-select-sm" name="marca" onchange="aplicarFiltros()">
                <option value="">Todas</option>
                {% for marca in marcas %}
                <option value="{{ marca|lower }}">{{ marca }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6 col-xl-3">
              <label class="form-label">Modelo</label>
              <select class="form-select form-select-sm" name="modelo" onchange="aplicarFiltros()">
                <option value="">Todos</option>
                {% for modelo in modelos %}
                <option value="{{ modelo|lower }}">{{ modelo }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6 col-xl-2">
              <label class="form-label">Año</label>
              <select class="form-select form-select-sm" name="anio" onchange="aplicarFiltros()">
                <option value="">Todos</option>
                {% for anio in anios %}
                <option value="{{ anio }}">{{ anio }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6 col-xl-2">
              <label class="form-label">Tipo</label>
              <select class="form-select form-select-sm" name="tipo" onchange="aplicarFiltros()">
                <option value="">Todos</option>
                {% for tipo in tipos %}
                <option value="{{ tipo|lower }}">{{ tipo }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6 col-xl-2">
              <label class="form-label">Precio mín.</label>
              <input type="number"
                     class="form-control form-control-sm"
                     name="precio_min"
                     placeholder="{{ '{:,.0f}'.format(min_precio) if min_precio else '0' }}"
                     oninput="aplicarFiltros()">
            </div>

            <div class="col-md-6 col-xl-2">
              <label class="form-label">Precio máx.</label>
              <input type="number"
                     class="form-control form-control-sm"
                     name="precio_max"
                     placeholder="{{ '{:,.0f}'.format(max_precio) if max_precio else '0' }}"
                     oninput="aplicarFiltros()">
            </div>
          </form>
        </div>
      </div>

      <!-- CATÁLOGO -->
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="text-white mb-0">
          Vehículos disponibles
        </h5>
        <span class="badge bg-success">
          {{ vehiculos|length }} vehículos listos para compra
        </span>
      </div>

      <div class="row g-3" id="vehiculosGrid">
        {% if vehiculos %}
          {% for v in vehiculos %}
          <div class="col-md-6">
            <div class="card vehicle-card h-100 vehiculo-item"
                 data-marca="{{ v.marca|lower }}"
                 data-modelo="{{ v.modelo|lower }}"
                 data-tipo="{{ v.tipo|lower }}"
                 data-anio="{{ v.anio }}"
                 data-precio="{{ v.precio }}">
              {% if v.imagen_url %}
              <img src="{{ v.imagen_url }}"
                   class="card-img-top vehicle-img"
                   alt="{{ v.marca }} {{ v.modelo }}">
              {% else %}
              <div class="bg-dark d-flex align-items-center justify-content-center" style="height: 180px;">
                <i class="fa-solid fa-car fa-3x text-muted"></i>
              </div>
              {% endif %}

              <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <h6 class="mb-0 text-white">{{ v.marca }} {{ v.modelo }}</h6>
                  <span class="badge bg-secondary">{{ v.anio }}</span>
                </div>
                <p class="text-soft mb-2">
                  {{ v.tipo }} • {{ v.color }}
                </p>
                <p class="text-soft small flex-grow-1">
                  {{ v.descripcion or 'Vehículo en excelentes condiciones, listo para entrega.' }}
                </p>
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <span class="price-tag text-success fw-bold">
                    ${{ "{:,.2f}".format(v.precio) }}
                  </span>
                  <form method="POST"
                        action="{{ url_for('client.comprar', vehiculo_id=v.vehiculo_id) }}">
                    <button type="submit" class="btn btn-sm btn-success">
                      <i class="fa-solid fa-cart-shopping me-1"></i> Comprar ahora
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        {% else %}
        <div class="col-12">
          <div class="card text-center">
            <div class="card-body">
              <i class="fa-solid fa-car-burst fa-3x text-muted mb-3"></i>
              <p class="text-muted mb-0">No hay vehículos disponibles por el momento.</p>
            </div>
          </div>
        </div>
        {% endif %}
      </div>

    </div>

    <!-- ======================================
         COLUMNA DERECHA: RESUMEN + POPULARES
         ====================================== -->
    <div class="col-lg-4">

      <!-- RESUMEN RÁPIDO (se mantiene) -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-gauge-high me-2"></i> Resumen rápido</span>
        </div>
        <div class="card-body">
          <p class="mb-1 text-soft">Vehículos listos para ti</p>
          <div class="display-4 fw-bold text-primary">
            {{ resumen.vehiculos_disponibles }}
          </div>
          <p class="text-muted small mb-0">
            Puedes filtrar por marca, modelo, año, tipo y rango de precio para encontrar
            el vehículo ideal.
          </p>
        </div>
      </div>

      <!-- COCHES POPULARES -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-fire me-2"></i> Coches populares</span>
          <small class="text-muted">Más solicitados</small>
        </div>
        <div class="card-body">
          {% if populares %}
          <div class="popular-list">
            {% for p in populares %}
            <div class="popular-item d-flex mb-3">
              {% if p.imagen_url %}
              <img src="{{ p.imagen_url }}"
                   class="popular-thumb me-3"
                   alt="{{ p.marca }} {{ p.modelo }}">
              {% else %}
              <div class="popular-thumb me-3 d-flex align-items-center justify-content-center bg-dark">
                <i class="fa-solid fa-car text-muted"></i>
              </div>
              {% endif %}
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between">
                  <h6 class="mb-0 text-white">{{ p.marca }} {{ p.modelo }}</h6>
                  <span class="badge bg-secondary">{{ p.anio }}</span>
                </div>
                <small class="text-soft d-block mb-1">
                  {{ p.tipo }} • {{ p.color }}
                </small>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-success fw-semibold small">
                    ${{ "{:,.0f}".format(p.precio) }}
                  </span>
                  <form method="POST"
                        action="{{ url_for('client.comprar', vehiculo_id=p.vehiculo_id) }}">
                    <button type="submit" class="btn btn-sm btn-outline-success">
                      Ver más
                    </button>
                  </form>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-muted mb-0 small">
            Aún no hay suficiente movimiento para mostrar coches populares.
          </p>
          {% endif %}
        </div>
      </div>

    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // ====== Filtros en tiempo real ======
  function aplicarFiltros() {
    const form = document.getElementById('filtrosForm');
    if (!form) return;

    const data = new FormData(form);

    const marca = (data.get('marca') || '').toLowerCase();
    const modelo = (data.get('modelo') || '').toLowerCase();
    const tipo = (data.get('tipo') || '').toLowerCase();
    const anio = data.get('anio') || '';
    const precioMin = parseFloat(data.get('precio_min')) || 0;
    const precioMaxRaw = data.get('precio_max');
    const precioMax = precioMaxRaw ? parseFloat(precioMaxRaw) : Number.POSITIVE_INFINITY;

    const items = document.querySelectorAll('.vehiculo-item');

    items.forEach(item => {
      const dMarca = (item.dataset.marca || '').toLowerCase();
      const dModelo = (item.dataset.modelo || '').toLowerCase();
      const dTipo = (item.dataset.tipo || '').toLowerCase();
      const dAnio = item.dataset.anio || '';
      const dPrecio = parseFloat(item.dataset.precio) || 0;

      const okMarca = !marca || dMarca === marca;
      const okModelo = !modelo || dModelo === modelo;
      const okTipo = !tipo || dTipo === tipo;
      const okAnio = !anio || dAnio === anio;
      const okPrecio = dPrecio >= precioMin && dPrecio <= precioMax;

      if (okMarca && okModelo && okTipo && okAnio && okPrecio) {
        item.style.display = '';
      } else {
        item.style.display = 'none';
      }
    });
  }

  function limpiarFiltros() {
    const form = document.getElementById('filtrosForm');
    if (!form) return;
    form.reset();
    aplicarFiltros();
  }

  document.addEventListener('DOMContentLoaded', function () {
    aplicarFiltros();
  });
</script>

<style>
  .text-soft {
    color: #9ca3af;
  }

  .price-tag {
    font-size: 1.05rem;
  }

  .vehicle-card {
    background: rgba(15, 23, 42, 0.9);
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 1rem;
    overflow: hidden;
  }

  .vehicle-card .vehicle-img {
    height: 170px;
    object-fit: cover;
  }

  .popular-thumb {
    width: 72px;
    height: 56px;
    border-radius: .5rem;
    object-fit: cover;
  }

  .popular-list {
    max-height: 340px;
    overflow-y: auto;
  }
</style>
{% endblock %}
