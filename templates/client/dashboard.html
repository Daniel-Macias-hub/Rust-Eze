{% extends "layouts/client_base.html" %}
{% block title %}Panel de cliente - Rust-Eze{% endblock %}

{% block client_content %}
<div class="container-fluid py-4 client-dashboard-shell">

  <!-- ==========================
       HERO / ENCABEZADO CLIENTE
       ========================== -->
  <section class="hero-shell mb-4">
    <span class="hero-chip">
      <i class="fa-solid fa-user-gear me-1"></i>
      Panel de cliente
    </span>

    <h2 class="hero-title">
      Explora, elige y compra tu próximo
      <span class="hero-gradient">vehículo</span>
    </h2>

    <p class="hero-subtitle">
      Bienvenido, {{ session.get('user_name') }}. Desde aquí puedes filtrar el catálogo,
      ver coches populares y comprar tu auto ideal.
    </p>

    <!-- Acciones rápidas (mismo patrón que admin) -->
    <div class="row g-3 mt-3 quick-actions-row">
      <!-- Explorar catálogo (esta misma vista) -->
      <div class="col-md-4 col-lg-3">
        <a href="{{ url_for('client.dashboard') }}"
           class="quick-action-card">
          <span class="quick-action-icon qa-vehiculos">
            <i class="fa-solid fa-car-side"></i>
          </span>
          <div class="quick-action-body">
            <span class="quick-action-label">Explorar catálogo</span>
            <small>Vehículos disponibles listos para compra.</small>
          </div>
          <span class="quick-action-pill">Ver</span>
        </a>
      </div>

      <!-- Mis compras (placeholder) -->
      <div class="col-md-4 col-lg-3">
        <a href="#"
           class="quick-action-card">
          <span class="quick-action-icon qa-clientes">
            <i class="fa-solid fa-receipt"></i>
          </span>
          <div class="quick-action-body">
            <span class="quick-action-label">Mis compras</span>
            <small>Historial de vehículos adquiridos.</small>
          </div>
          <span class="quick-action-pill">Revisar</span>
        </a>
      </div>

      <!-- Mi perfil -->
      <div class="col-md-4 col-lg-3">
        <a href="{{ url_for('client.perfil') }}"
           class="quick-action-card">
          <span class="quick-action-icon qa-empleados">
            <i class="fa-solid fa-id-card"></i>
          </span>
          <div class="quick-action-body">
            <span class="quick-action-label">Mi perfil</span>
            <small>Datos personales y seguridad de la cuenta.</small>
          </div>
          <span class="quick-action-pill">Editar</span>
        </a>
      </div>
    </div>
  </section>

  <div class="row g-4">

    <!-- ======================================
         COLUMNA IZQUIERDA: FILTROS + CATÁLOGO
         ====================================== -->
    <div class="col-lg-8">

      <!-- FILTROS -->
      <div class="card card-hover-glow mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>
            <i class="fa-solid fa-filter me-2"></i> Filtros
          </span>
          <button type="button"
                  class="btn btn-sm btn-outline-light"
                  onclick="limpiarFiltros()">
            Limpiar filtros
          </button>
        </div>
        <div class="card-body">
          <form id="filtrosForm" class="row g-3">
            <div class="col-md-6 col-xl-3">
              <label class="form-label">Marca</label>
              <select class="form-select form-select-sm" name="marca" onchange="aplicarFiltros()">
                <option value="">Todas</option>
                {% for marca in marcas %}
                  <option value="{{ marca|lower }}">{{ marca }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6 col-xl-3">
              <label class="form-label">Modelo</label>
              <select class="form-select form-select-sm" name="modelo" onchange="aplicarFiltros()">
                <option value="">Todos</option>
                {% for modelo in modelos %}
                  <option value="{{ modelo|lower }}">{{ modelo }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6 col-xl-2">
              <label class="form-label">Año</label>
              <select class="form-select form-select-sm" name="anio" onchange="aplicarFiltros()">
                <option value="">Todos</option>
                {% for anio in anios %}
                  <option value="{{ anio }}">{{ anio }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6 col-xl-2">
              <label class="form-label">Tipo</label>
              <select class="form-select form-select-sm" name="tipo" onchange="aplicarFiltros()">
                <option value="">Todos</option>
                {% for tipo in tipos %}
                  <option value="{{ tipo|lower }}">{{ tipo }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6 col-xl-2">
              <label class="form-label">Precio mín.</label>
              <input type="number"
                     class="form-control form-control-sm"
                     name="precio_min"
                     placeholder="{{ '{:,.0f}'.format(min_precio) if min_precio else '0' }}"
                     oninput="aplicarFiltros()">
            </div>

            <div class="col-md-6 col-xl-2">
              <label class="form-label">Precio máx.</label>
              <input type="number"
                     class="form-control form-control-sm"
                     name="precio_max"
                     placeholder="{{ '{:,.0f}'.format(max_precio) if max_precio else '0' }}"
                     oninput="aplicarFiltros()">
            </div>
          </form>
        </div>
      </div>

      <!-- CATÁLOGO -->
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="text-readable mb-0">
          Vehículos disponibles
        </h5>
        <span class="badge bg-success">
          {{ vehiculos|length }} vehículos listos para compra
        </span>
      </div>

      <div class="row g-3" id="vehiculosGrid">
        {% if vehiculos %}
          {% for v in vehiculos %}
          <div class="col-md-6">
            <div class="card vehicle-card card-hover-glow h-100 vehiculo-item"
                 data-marca="{{ v.marca|lower }}"
                 data-modelo="{{ v.modelo|lower }}"
                 data-tipo="{{ v.tipo|lower }}"
                 data-anio="{{ v.anio }}"
                 data-precio="{{ v.precio }}">
              {% if v.imagen_url %}
              <img src="{{ v.imagen_url }}"
                   class="card-img-top vehicle-img"
                   alt="{{ v.marca }} {{ v.modelo }}">
              {% else %}
              <div class="bg-dark d-flex align-items-center justify-content-center vehicle-img">
                <i class="fa-solid fa-car fa-3x text-muted"></i>
              </div>
              {% endif %}

              <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <h6 class="mb-0 text-readable">{{ v.marca }} {{ v.modelo }}</h6>
                  <span class="badge bg-secondary">{{ v.anio }}</span>
                </div>
                <p class="text-soft mb-2">
                  {{ v.tipo }} • {{ v.color }}
                </p>
                <p class="text-soft small flex-grow-1">
                  {{ v.descripcion or 'Vehículo en excelentes condiciones, listo para entrega.' }}
                </p>
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <span class="price-tag">
                    ${{ "{:,.2f}".format(v.precio) }}
                  </span>
                  <form method="POST"
                        action="{{ url_for('client.comprar', vehiculo_id=v.vehiculo_id) }}">
                    <button type="submit" class="btn btn-sm btn-success">
                      <i class="fa-solid fa-cart-shopping me-1"></i> Comprar ahora
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        {% else %}
        <div class="col-12">
          <div class="card card-hover-glow text-center">
            <div class="card-body">
              <i class="fa-solid fa-car-burst fa-3x text-muted mb-3"></i>
              <p class="text-soft mb-0">No hay vehículos disponibles por el momento.</p>
            </div>
          </div>
        </div>
        {% endif %}
      </div>

    </div>

    <!-- ======================================
         COLUMNA DERECHA: RESUMEN + POPULARES
         ====================================== -->
    <div class="col-lg-4">

      <!-- RESUMEN RÁPIDO -->
      <div class="card card-hover-glow mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-gauge-high me-2"></i> Resumen rápido</span>
        </div>
        <div class="card-body">
          <p class="mb-1 text-soft">Vehículos listos para ti</p>
          <div class="display-4 fw-bold text-readable">
            {{ resumen.vehiculos_disponibles }}
          </div>
          <p class="text-soft small mb-0">
            Filtra por marca, modelo, año, tipo y rango de precio para encontrar el vehículo ideal.
          </p>
        </div>
      </div>

      <!-- COCHES POPULARES -->
      <div class="card card-hover-glow">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fa-solid fa-fire me-2"></i> Coches populares</span>
          <small class="text-muted-strong">Más solicitados</small>
        </div>
        <div class="card-body">
          {% if populares %}
          <div class="popular-list">
            {% for p in populares %}
            <div class="popular-item d-flex mb-3">
              {% if p.imagen_url %}
              <img src="{{ p.imagen_url }}"
                   class="popular-thumb me-3"
                   alt="{{ p.marca }} {{ p.modelo }}">
              {% else %}
              <div class="popular-thumb me-3 d-flex align-items-center justify-content-center bg-dark">
                <i class="fa-solid fa-car text-muted"></i>
              </div>
              {% endif %}
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between">
                  <h6 class="mb-0 text-readable">{{ p.marca }} {{ p.modelo }}</h6>
                  <span class="badge bg-secondary">{{ p.anio }}</span>
                </div>
                <small class="text-soft d-block mb-1">
                  {{ p.tipo }} • {{ p.color }}
                </small>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="text-success fw-semibold small">
                    ${{ "{:,.0f}".format(p.precio) }}
                  </span>
                  <form method="POST"
                        action="{{ url_for('client.comprar', vehiculo_id=p.vehiculo_id) }}">
                    <button type="submit" class="btn btn-sm btn-outline-success">
                      Ver más
                    </button>
                  </form>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-soft mb-0 small">
            Aún no hay suficiente movimiento para mostrar coches populares.
          </p>
          {% endif %}
        </div>
      </div>

    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // ====== Filtros en tiempo real ======
  function aplicarFiltros() {
    const form = document.getElementById('filtrosForm');
    if (!form) return;

    const data = new FormData(form);

    const marca = (data.get('marca') || '').toLowerCase();
    const modelo = (data.get('modelo') || '').toLowerCase();
    const tipo = (data.get('tipo') || '').toLowerCase();
    const anio = data.get('anio') || '';
    const precioMin = parseFloat(data.get('precio_min')) || 0;
    const precioMaxRaw = data.get('precio_max');
    const precioMax = precioMaxRaw ? parseFloat(precioMaxRaw) : Number.POSITIVE_INFINITY;

    const items = document.querySelectorAll('.vehiculo-item');

    items.forEach(item => {
      const dMarca = (item.dataset.marca || '').toLowerCase();
      const dModelo = (item.dataset.modelo || '').toLowerCase();
      const dTipo = (item.dataset.tipo || '').toLowerCase();
      const dAnio = item.dataset.anio || '';
      const dPrecio = parseFloat(item.dataset.precio) || 0;

      const okMarca = !marca || dMarca === marca;
      const okModelo = !modelo || dModelo === modelo;
      const okTipo = !tipo || dTipo === tipo;
      const okAnio = !anio || dAnio === anio;
      const okPrecio = dPrecio >= precioMin && dPrecio <= precioMax;

      item.style.display = (okMarca && okModelo && okTipo && okAnio && okPrecio)
        ? ''
        : 'none';
    });
  }

  function limpiarFiltros() {
    const form = document.getElementById('filtrosForm');
    if (!form) return;
    form.reset();
    aplicarFiltros();
  }

  document.addEventListener('DOMContentLoaded', function () {
    aplicarFiltros();
  });
</script>

<style>
  /* Fondo del panel de cliente: sobrescribe el body blanco de Bootstrap
     SOLO en esta vista (por estar en este template). */
  body {
    background: radial-gradient(circle at 0% 0%, #020617 0%, #020617 35%, #0b1120 75%, #111827 100%) !important;
    color: #f9fafb;
  }

  /* Evitar fondos blancos en contenedores principales */
  .client-dashboard-shell {
    background-color: transparent !important;
  }

  /* Listado de populares (estilos específicos de esta vista) */
  .popular-thumb {
    width: 72px;
    height: 56px;
    border-radius: .5rem;
    object-fit: cover;
  }

  .popular-list {
    max-height: 340px;
    overflow-y: auto;
  }
</style>
{% endblock %}
